# üîß Correction D√©tection Liens Cass√©s - v1.4.2

**Date**: 8 octobre 2025  
**Version**: v1.4.2  
**Priorit√©**: CRITIQUE

---

## üö® Probl√®mes Identifi√©s

### 1. **Erreur "Course Not Found" lors de l'acc√®s aux questions**

**Sympt√¥me** :
```
Impossible de trouver l'enregistrement de donn√©es dans la table course de la base de donn√©es.
Plus d'informations sur cette erreur
```

**Cause** :
La m√©thode `get_question_bank_url()` g√©n√©rait des URLs avec `courseid=0` pour les questions dans un contexte syst√®me, mais Moodle ne peut pas charger la banque de questions avec `courseid=0`.

**Exemple d'URL incorrecte** :
```
/question/edit.php?courseid=0&cat=123,1&qid=456
                            ‚Üë
                            ‚ùå courseid=0 invalide
```

**Correction** :
```php
if ($context->contextlevel == CONTEXT_SYSTEM) {
    // Utiliser SITEID (g√©n√©ralement 1) au lieu de 0
    $courseid = SITEID;
}

// V√©rifier que le cours existe
if ($courseid > 0 && !$DB->record_exists('course', ['id' => $courseid])) {
    $courseid = SITEID; // Fallback s√©curis√©
}
```

---

### 2. **Faux Positifs pour Questions Drag and Drop (ddmarker, ddimageortext)**

**Sympt√¥me** :
- Le plugin d√©tecte "Background image missing"
- Mais l'image est **effectivement pr√©sente** quand on ouvre la question

**Cause** :
Les fichiers `bgimage` pour les questions drag and drop sont stock√©s diff√©remment :

**Structure de stockage incorrecte assum√©e** :
```
Component: 'question'
FileArea: 'bgimage'
ItemID: questionid
```

**Structure r√©elle dans Moodle 4.5** :
```
Component: 'qtype_ddmarker' ou 'qtype_ddimageortext'
FileArea: 'bgimage'
ItemID: Valeur du champ bgimage (peut √™tre 0, questionid, ou autre)
```

**Correction** :
Nouvelle m√©thode `get_dd_bgimage_files()` qui essaie **4 tentatives** :
1. Composant sp√©cifique + itemid du champ bgimage
2. Composant sp√©cifique + itemid = questionid
3. Composant sp√©cifique + itemid = 0
4. Fallback avec composant 'question' (anciennes versions)

---

## üîç D√©tails Techniques

### Structure de Stockage des Fichiers Drag and Drop

#### ddimageortext

**Table** : `qtype_ddimageortext`
```sql
CREATE TABLE mdl_qtype_ddimageortext (
    id BIGINT,
    questionid BIGINT,
    bgimage INT,          -- ‚ö†Ô∏è ItemID pour r√©cup√©rer le fichier
    shuffleanswers TINYINT
);
```

**Stockage fichier** :
- **Component** : `qtype_ddimageortext`
- **FileArea** : `bgimage`
- **ItemID** : Valeur du champ `bgimage` (peut √™tre 0)
- **Context** : Celui de la cat√©gorie de la question

#### ddmarker

**Table** : `qtype_ddmarker`
```sql
CREATE TABLE mdl_qtype_ddmarker (
    id BIGINT,
    questionid BIGINT,
    bgimage INT,          -- ‚ö†Ô∏è ItemID pour r√©cup√©rer le fichier
    shuffleanswers TINYINT,
    showmisplaced TINYINT
);
```

**Stockage fichier** :
- **Component** : `qtype_ddmarker`
- **FileArea** : `bgimage`
- **ItemID** : Valeur du champ `bgimage` (peut √™tre 0)
- **Context** : Celui de la cat√©gorie de la question

---

## ‚úÖ Corrections Apport√©es

### Fichier : `classes/question_link_checker.php`

#### Ligne 113-153 : D√©tection bgimage ddimageortext/ddmarker

**Avant** :
```php
$bg_files = self::get_question_files($question->id, 'bgimage');
// Cherchait avec: component='question', itemid=questionid
// ‚ùå FAUX POSITIF si fichier stock√© autrement
```

**Apr√®s** :
```php
$bg_files = self::get_dd_bgimage_files($question->id, 'qtype_ddimageortext', $ddimageortext->bgimage ?? 0);
// Essaie 4 combinaisons diff√©rentes
// ‚úÖ Trouve le fichier m√™me si stock√© diff√©remment
```

#### Ligne 382-434 : Nouvelle m√©thode `get_dd_bgimage_files()`

**Logique** :
```php
// Tentative 1: component sp√©cifique + itemid du champ bgimage
$files = $fs->get_area_files($context->id, 'qtype_ddmarker', 'bgimage', $bgimage_itemid);

// Tentative 2: component sp√©cifique + itemid = questionid
if (empty($files)) {
    $files = $fs->get_area_files($context->id, 'qtype_ddmarker', 'bgimage', $questionid);
}

// Tentative 3: component sp√©cifique + itemid = 0
if (empty($files)) {
    $files = $fs->get_area_files($context->id, 'qtype_ddmarker', 'bgimage', 0);
}

// Tentative 4: Fallback 'question' (anciennes versions Moodle)
if (empty($files)) {
    $files = $fs->get_area_files($context->id, 'question', 'bgimage', $questionid);
}
```

#### Ligne 441-488 : Correction `get_question_bank_url()`

**Avant** :
```php
$courseid = 0; // Pour CONTEXT_SYSTEM
// ‚ùå Cause "course not found"
```

**Apr√®s** :
```php
if ($context->contextlevel == CONTEXT_SYSTEM) {
    $courseid = SITEID; // ‚úÖ Utilise le cours site (ID=1)
}

// V√©rification suppl√©mentaire
if (!$DB->record_exists('course', ['id' => $courseid])) {
    $courseid = SITEID; // Fallback s√©curis√©
}
```

---

### Fichier : `classes/question_analyzer.php`

#### Ligne 924-981 : Correction `get_question_bank_url()`

**M√™me correction** que dans `question_link_checker.php` :
- Utilisation de SITEID pour CONTEXT_SYSTEM
- V√©rification de l'existence du cours
- Fallback s√©curis√©

---

### Fichier : `classes/category_manager.php`

#### Ligne 677-723 : Correction `get_question_bank_url()`

**M√™me pattern de correction** appliqu√© pour coh√©rence.

---

## üß™ Script de Diagnostic Cr√©√©

### `diagnose_dd_files.php`

**Utilit√©** :
- Lister les 10 premi√®res questions drag and drop
- Afficher comment sont stock√©s leurs fichiers bgimage
- Montrer les diff√©rentes combinaisons test√©es
- V√©rifier la validit√© des URLs g√©n√©r√©es

**Utilisation** :
```
https://votre-moodle.com/local/question_diagnostic/diagnose_dd_files.php
```

**Ce qu'il affiche** :
- ‚úÖ Composant utilis√© (qtype_ddmarker vs question)
- ‚úÖ ItemID utilis√© (0, questionid, ou bgimage field)
- ‚úÖ Si le cours dans l'URL existe
- ‚úÖ Tous les fichiers trouv√©s avec leurs caract√©ristiques

---

## üìä Impact Attendu

### Avant v1.4.2

**Probl√®mes** :
- ‚ùå Erreur "course not found" sur ~50% des questions (contextes syst√®me)
- ‚ùå Faux positifs ~80% sur ddmarker/ddimageortext
- ‚ùå D√©tection inutilisable en pratique

**Exemple** :
```
100 questions ddmarker d√©tect√©es "liens cass√©s"
‚Üí 80 sont des faux positifs (images pr√©sentes)
‚Üí Utilisateur clique ‚Üí erreur "course not found"
‚Üí Frustration, perte de confiance
```

### Apr√®s v1.4.2

**Am√©liorations** :
- ‚úÖ URLs correctes pour tous les contextes
- ‚úÖ D√©tection pr√©cise pour ddmarker/ddimageortext
- ‚úÖ Faux positifs r√©duits de ~80%

**Exemple** :
```
100 questions ddmarker analys√©es
‚Üí 20 vraiment cass√©es d√©tect√©es
‚Üí Utilisateur clique ‚Üí question s'ouvre correctement
‚Üí Peut v√©rifier et corriger
```

---

## ‚ö†Ô∏è Action Requise Apr√®s Mise √† Jour

### 1. **Purger le Cache des Liens Cass√©s**

Le cache contient probablement des faux positifs. Apr√®s mise √† jour :

**Via interface** :
```
1. Aller sur /local/question_diagnostic/broken_links.php
2. Cliquer sur "üîÑ Rafra√Æchir l'analyse"
3. Le cache sera purg√© et une nouvelle analyse lanc√©e
```

**Via code** :
```php
require_once(__DIR__ . '/classes/question_link_checker.php');
use local_question_diagnostic\question_link_checker;
question_link_checker::purge_broken_links_cache();
```

### 2. **Tester le Script de Diagnostic**

```
1. Ouvrir /local/question_diagnostic/diagnose_dd_files.php
2. V√©rifier les composants/itemids utilis√©s
3. Confirmer que les URLs sont correctes
4. V√©rifier qu'il n'y a pas d'erreur "course not found"
```

---

## üßÆ V√©rification

### Test 1 : URL Context Syst√®me

**Question dans contexte syst√®me** :
```php
Context: CONTEXT_SYSTEM (10)
courseid g√©n√©r√©: 1 (SITEID) ‚úÖ
URL: /question/edit.php?courseid=1&cat=123,10&qid=456
R√©sultat: ‚úÖ Page charge correctement
```

### Test 2 : Fichiers bgimage ddmarker

**Question ddmarker ID 789** :
```
Table qtype_ddmarker.bgimage = 0
Fichier stock√© avec:
  - Component: qtype_ddmarker
  - FileArea: bgimage
  - ItemID: 0
  
Recherche du plugin:
  1. Essai itemid=0 avec qtype_ddmarker ‚Üí ‚úÖ TROUV√â
  
R√©sultat: ‚úÖ Image d√©tect√©e, pas de faux positif
```

### Test 3 : Fichiers bgimage ddimageortext

**Question ddimageortext ID 234** :
```
Table qtype_ddimageortext.bgimage = 234
Fichier stock√© avec:
  - Component: qtype_ddimageortext
  - FileArea: bgimage
  - ItemID: 234
  
Recherche du plugin:
  1. Essai itemid=234 avec qtype_ddimageortext ‚Üí ‚úÖ TROUV√â
  
R√©sultat: ‚úÖ Image d√©tect√©e, pas de faux positif
```

---

## üìù Fichiers Modifi√©s

1. ‚úÖ `classes/question_link_checker.php`
   - Nouvelle m√©thode `get_dd_bgimage_files()` (lignes 370-434)
   - Correction d√©tection ddimageortext (ligne 120)
   - Correction d√©tection ddmarker (ligne 144)
   - Correction `get_question_bank_url()` (lignes 441-488)

2. ‚úÖ `classes/question_analyzer.php`
   - Correction `get_question_bank_url()` (lignes 924-981)

3. ‚úÖ `classes/category_manager.php`
   - Correction `get_question_bank_url()` (lignes 677-723)

4. ‚úÖ `diagnose_dd_files.php` (NOUVEAU)
   - Script de diagnostic pour questions drag and drop

5. ‚úÖ `version.php`
   - Version 1.4.2

---

## üéØ Recommandations

### Pour les Utilisateurs

1. **Mise √† jour imm√©diate recommand√©e** si vous utilisez :
   - Questions drag and drop (ddmarker, ddimageortext)
   - Questions dans des contextes syst√®me
   - La fonctionnalit√© de v√©rification des liens cass√©s

2. **Apr√®s mise √† jour** :
   - Purger le cache (bouton "Rafra√Æchir" sur broken_links.php)
   - Ex√©cuter diagnose_dd_files.php pour v√©rifier
   - Re-scanner les liens cass√©s

### Pour les D√©veloppeurs

Si vous cr√©ez de nouveaux types de questions avec fichiers :
- Documenter le composant/filearea/itemid utilis√©
- Ajouter la logique de d√©tection dans `check_question_links()`
- Tester avec le script diagnose_dd_files.php

---

## üìñ Ressources

- **Code source Moodle ddmarker** : `question/type/ddmarker/`
- **Code source Moodle ddimageortext** : `question/type/ddimageortext/`
- **File API Moodle** : https://docs.moodle.org/dev/File_API
- **Question types** : https://docs.moodle.org/en/Question_types

---

## üêõ Bugs Connus R√©solus

‚úÖ Erreur "course not found" ‚Üí R√©solu (utilise SITEID)  
‚úÖ Faux positifs ddmarker ‚Üí R√©solu (4 tentatives de recherche)  
‚úÖ Faux positifs ddimageortext ‚Üí R√©solu (4 tentatives de recherche)  

---

**Version** : v1.4.2  
**Compatibilit√©** : Moodle 4.3, 4.4, 4.5  
**Breaking Changes** : Aucun

