# üßπ Fonctionnalit√© : Nettoyage global des cat√©gories

**Version** : v1.10.2  
**Date de cr√©ation** : Octobre 2025  
**Statut** : ‚úÖ Impl√©ment√©

---

## üìù Description

Cette fonctionnalit√© permet de **supprimer automatiquement toutes les cat√©gories supprimables** du site en une seule op√©ration. Elle identifie et supprime en masse toutes les cat√©gories vides et non prot√©g√©es, avec traitement par lots pour √©viter les timeouts sur de grandes bases de donn√©es.

## üéØ Objectifs

1. **Automatiser** le nettoyage complet des cat√©gories inutilis√©es
2. **Identifier** toutes les cat√©gories supprimables en une seule analyse
3. **Traiter par lots** pour supporter de grandes bases de donn√©es
4. **Prot√©ger** automatiquement les cat√©gories importantes
5. **Auditer** toutes les suppressions avec tra√ßabilit√© compl√®te

## üìÇ Fichiers cr√©√©s/modifi√©s

### Nouveaux fichiers
- `actions/cleanup_all_categories.php` - Action de nettoyage global

### Fichiers modifi√©s
- `categories.php` - Ajout bouton "üßπ Nettoyage Global"
- `lang/fr/local_question_diagnostic.php` - Cha√Ænes de langue FR
- `lang/en/local_question_diagnostic.php` - Cha√Ænes de langue EN

## üèóÔ∏è Architecture technique

### Flux de l'outil

```
1. PREVIEW (Pr√©visualisation)
   ‚Üì
   ‚Üí Analyse toutes les cat√©gories
   ‚Üí Calcule statistiques (√† supprimer / √† conserver)
   ‚Üí Affiche dashboard + confirmation
   ‚Üì
2. CONFIRM (Confirmation)
   ‚Üì
   ‚Üí Utilisateur confirme ou t√©l√©charge CSV
   ‚Üì
3. EXECUTE (Ex√©cution par lots)
   ‚Üì
   ‚Üí Traitement par lots de 20 cat√©gories
   ‚Üí Suppression + Audit logging
   ‚Üí Auto-redirection vers lot suivant
   ‚Üì
4. COMPLETE (R√©sum√© final)
   ‚Üì
   ‚Üí Affiche statistiques finales
   ‚Üí Lien retour vers categories.php
```

### Modes de fonctionnement

#### Mode 1 : PREVIEW (Pr√©visualisation)
- URL : `?preview=1&sesskey=XXX`
- Analyse toutes les cat√©gories du site
- Calcule les statistiques de nettoyage
- Affiche :
  - Dashboard avec 4 cartes (Total, √Ä supprimer, √Ä conserver, Temps estim√©)
  - D√©tails par type (vides, orphelines)
  - R√®gles de protection appliqu√©es
  - Boutons : T√©l√©charger CSV / Confirmer / Annuler

#### Mode 2 : DOWNLOAD_CSV (Export)
- URL : `?download_csv=1&sesskey=XXX`
- G√©n√®re un fichier CSV avec la liste compl√®te
- Colonnes : ID, Nom, Context ID, Contexte, Parent ID, Vide, Orpheline, Action
- Encodage UTF-8 avec BOM pour Excel

#### Mode 3 : EXECUTE (Ex√©cution par lots)
- URL : `?execute=1&batch=N&sesskey=XXX`
- Traite 20 cat√©gories par lot
- Affiche :
  - Barre de progression
  - Liste des cat√©gories supprim√©es/erreurs
  - Statistiques cumul√©es
  - Auto-redirection vers lot suivant
- Stockage en session : `$_SESSION['cleanup_categories_deleted']`

#### Mode 4 : COMPLETE (R√©sum√© final)
- URL : `?complete=1&deleted=X&errors=Y&sesskey=XXX`
- Affiche le r√©sum√© final
- Nettoie les variables de session
- Lien retour vers categories.php

## üõ°Ô∏è R√®gles de protection

### Cat√©gories PROT√âG√âES (non supprimables)

1. ‚úÖ **Cat√©gories "Default for..."** : Cat√©gories par d√©faut Moodle
2. ‚úÖ **Cat√©gories avec description** : Ont une description (champ `info`)
3. ‚úÖ **Cat√©gories racine** : Parent = 0 (top-level)
4. ‚úÖ **Cat√©gories avec questions** : Contiennent au moins 1 question
5. ‚úÖ **Cat√©gories avec sous-cat√©gories** : Ont des enfants

### Cat√©gories SUPPRIMABLES

- ‚úÖ Vides (0 questions ET 0 sous-cat√©gories)
- ‚úÖ Non prot√©g√©es
- ‚úÖ OU orphelines (contexte invalide)

## üìä Statistiques calcul√©es

```php
$stats = new stdClass();
$stats->total_categories = X;           // Total dans la base
$stats->total_to_delete = Y;            // Supprimables
$stats->total_to_keep = Z;              // √Ä conserver
$stats->empty_to_delete = N;            // Vides supprimables
$stats->empty_to_keep = M;              // Vides prot√©g√©es
$stats->orphan_to_delete = P;           // Orphelines supprimables
$stats->orphan_to_keep = Q;             // Orphelines prot√©g√©es
$stats->estimated_time_seconds = T;     // ~0.3s par cat√©gorie
$stats->estimated_batches = B;          // Nombre de lots
$stats->categories_list = [];           // Liste pour CSV
```

## üíæ Performances

### Param√®tres de traitement

- **Taille de lot** : 20 cat√©gories par batch (`BATCH_SIZE`)
- **Temps par cat√©gorie** : ~0.3 secondes
- **Auto-redirection** : 2 secondes entre les lots
- **Session storage** : Compteurs cumul√©s

### Exemples de temps

| Cat√©gories √† supprimer | Lots | Temps total estim√© |
|------------------------|------|--------------------|
| 20                     | 1    | ~6 secondes        |
| 100                    | 5    | ~30 secondes       |
| 500                    | 25   | ~2.5 minutes       |
| 1000                   | 50   | ~5 minutes         |

### Optimisations

1. **Traitement par lots** : √âvite les timeouts PHP
2. **Auto-redirection** : Continuit√© automatique entre lots
3. **Session storage** : Conserve les compteurs entre requ√™tes
4. **Requ√™tes SQL optimis√©es** : Utilise `get_all_categories_with_stats()` pr√©-optimis√©e

## üîí S√©curit√©

### Validations

1. ‚úÖ **Admin uniquement** : `is_siteadmin()` requis
2. ‚úÖ **Session key** : `require_sesskey()` sur toutes les actions
3. ‚úÖ **Confirmation utilisateur** : Page de pr√©visualisation obligatoire
4. ‚úÖ **Double v√©rification** : `can_delete_category()` avant suppression
5. ‚úÖ **Protection automatique** : R√®gles strictes appliqu√©es

### Audit logging

Chaque suppression est trac√©e avec :
- **Action** : `ACTION_DELETE_CATEGORY`
- **Type** : `category`
- **Item ID** : ID de la cat√©gorie
- **Item name** : Nom de la cat√©gorie
- **User ID** : Admin qui a lanc√© l'action
- **Metadata** : 
  - `context` : "Nettoyage global automatique"
  - `contextid` : ID du contexte
  - `was_empty` : 1 si vide
  - `was_orphan` : 1 si orpheline

## üé® Interface utilisateur

### Page de pr√©visualisation

#### Dashboard (4 cartes)
- **Total cat√©gories** : Nombre total dans la base
- **√Ä supprimer** : Nombre + pourcentage (rouge)
- **√Ä conserver** : Nombre + pourcentage (vert)
- **Temps estim√©** : Minutes + nombre de lots

#### Tableau d√©taill√©
| Type | √Ä supprimer | √Ä conserver |
|------|-------------|-------------|
| üóëÔ∏è Cat√©gories vides | X | Y |
| üëª Cat√©gories orphelines | X | Y |

#### Avertissement
- Message d'alerte rouge
- Compte des cat√©gories √† supprimer
- Liste des r√®gles de protection

#### Boutons d'action
- **üì• T√©l√©charger CSV** : Export de la liste
- **üöÄ Confirmer et lancer** : D√©marrage du nettoyage
- **‚Üê Annuler** : Retour √† categories.php

### Page d'ex√©cution

- **Titre** : "üöÄ Nettoyage en cours..."
- **Info** : "Traitement du lot X sur Y"
- **Barre de progression** : Pourcentage visuel anim√©
- **Liste** : ‚úÖ/‚ùå pour chaque cat√©gorie trait√©e
- **Statistiques** : Supprim√©es / Conserv√©es / Erreurs
- **Auto-redirection** : Vers lot suivant apr√®s 2s

### Page de r√©sum√©

- **Titre** : "‚úÖ Nettoyage global termin√©"
- **Message** : "üéâ Nettoyage termin√© avec succ√®s !"
- **Statistiques** : X cat√©gorie(s) supprim√©e(s)
- **Erreurs** : Si > 0, affichage en orange
- **Bouton** : "‚Üê Retour aux cat√©gories"

## üìã Export CSV

### Structure du fichier

```csv
ID;Nom;Context ID;Contexte;Parent ID;Vide;Orpheline;Action
123;Cat√©gorie Test;45;Course: Test;0;Oui;Non;Supprimer
```

### Caract√©ristiques
- **S√©parateur** : Point-virgule (`;`) pour Excel fran√ßais
- **Encodage** : UTF-8 avec BOM
- **Nom du fichier** : `cleanup_categories_YYYY-MM-DD_HHmmss.csv`

## ‚úÖ Tests recommand√©s

### Tests fonctionnels

1. ‚úÖ **Pr√©visualisation**
   - V√©rifier l'affichage des statistiques
   - V√©rifier le dashboard (4 cartes)
   - V√©rifier le tableau de d√©tails
   - V√©rifier les r√®gles de protection

2. ‚úÖ **Export CSV**
   - T√©l√©charger le CSV
   - V√©rifier l'encodage UTF-8
   - V√©rifier les donn√©es

3. ‚úÖ **Ex√©cution simple** (< 20 cat√©gories)
   - Lancer le nettoyage
   - V√©rifier la suppression
   - V√©rifier les logs d'audit
   - V√©rifier le r√©sum√©

4. ‚úÖ **Ex√©cution par lots** (> 20 cat√©gories)
   - Lancer le nettoyage
   - V√©rifier les auto-redirections
   - V√©rifier les compteurs cumul√©s
   - V√©rifier le r√©sum√© final

5. ‚úÖ **Protection**
   - Cr√©er cat√©gorie "Default for Test"
   - V√©rifier qu'elle n'est PAS dans la liste
   - Cr√©er cat√©gorie avec description
   - V√©rifier qu'elle n'est PAS dans la liste

6. ‚úÖ **Annulation**
   - Cliquer sur "Annuler"
   - V√©rifier retour √† categories.php
   - V√©rifier qu'aucune suppression n'a eu lieu

### Tests de performance

1. ‚úÖ **Petite base** (< 50 cat√©gories √† supprimer)
   - Temps < 30 secondes

2. ‚úÖ **Grande base** (> 500 cat√©gories √† supprimer)
   - V√©rifier l'ex√©cution par lots
   - V√©rifier l'absence de timeout
   - V√©rifier l'int√©grit√© des compteurs

### Tests de s√©curit√©

1. ‚úÖ **Acc√®s non autoris√©**
   - Tester l'acc√®s sans √™tre admin (doit √©chouer)

2. ‚úÖ **CSRF Protection**
   - Tester sans `sesskey` (doit √©chouer)

3. ‚úÖ **Protection des donn√©es**
   - V√©rifier qu'aucune cat√©gorie prot√©g√©e n'est supprim√©e

## üöÄ Utilisation

### Workflow complet

1. **Acc√©der** : Page categories.php ‚Üí Cliquer sur "üßπ Nettoyage Global"
2. **Analyser** : Examiner les statistiques de pr√©visualisation
3. **T√©l√©charger** (optionnel) : CSV pour archivage/documentation
4. **Confirmer** : Cliquer sur "üöÄ Confirmer et lancer"
5. **Patienter** : Laisser le traitement par lots s'ex√©cuter
6. **V√©rifier** : Consulter le r√©sum√© final
7. **Retour** : Cliquer sur "‚Üê Retour aux cat√©gories"

### Bonnes pratiques

1. ‚úÖ **Backup** : Faire une sauvegarde compl√®te AVANT
2. ‚úÖ **Test** : Tester sur environnement de d√©veloppement d'abord
3. ‚úÖ **CSV** : T√©l√©charger le CSV pour tra√ßabilit√©
4. ‚úÖ **Timing** : Lancer hors heures de production
5. ‚úÖ **V√©rification** : V√©rifier les logs d'audit apr√®s

## üîó Navigation

- **categories.php** ‚Üí Bouton "üßπ Nettoyage Global"
- **Preview** ‚Üí Boutons : CSV / Confirmer / Annuler
- **Execute** ‚Üí Auto-redirection entre lots
- **Complete** ‚Üí Bouton "‚Üê Retour aux cat√©gories"

## üìö Documentation connexe

- `docs/guides/USER_GUIDE.md` - Guide utilisateur
- `docs/features/FEATURE_BULK_OPERATIONS.md` - Op√©rations en masse
- `docs/technical/AUDIT_LOGGING.md` - Syst√®me d'audit
- `USER_CONSENT_PATTERNS.md` - Patterns de confirmation

## üìà M√©triques de succ√®s

- **Adoption** : Nombre d'utilisations par mois
- **Efficacit√©** : Nombre moyen de cat√©gories supprim√©es
- **Fiabilit√©** : Taux d'erreur < 1%
- **Performance** : Temps moyen < 5 minutes pour 1000 cat√©gories

## üöÄ √âvolutions futures possibles

1. **Planification** : Nettoyage automatique programm√© (cron)
2. **Notifications** : Email √† l'admin avec le r√©sum√©
3. **Dry-run avanc√©** : Mode simulation sans suppression r√©elle
4. **Filtres** : S√©lectionner les types de cat√©gories √† supprimer
5. **Restauration** : Trash temporaire avant suppression d√©finitive
6. **Statistiques** : Dashboard historique des nettoyages

## üë• Contributeurs

- **D√©veloppeur initial** : √âquipe local_question_diagnostic
- **Version** : v1.10.2
- **Date** : Octobre 2025

## üîç Diff√©rences avec cleanup_all_duplicates

| Fonctionnalit√© | Questions (duplicates) | Cat√©gories |
|----------------|----------------------|------------|
| **Cible** | Questions en doublon | Cat√©gories vides/orphelines |
| **Crit√®re** | M√™me nom + type | Vide OU orpheline |
| **Protection** | Questions utilis√©es | Cat√©gories prot√©g√©es |
| **Taille lot** | 10 groupes | 20 cat√©gories |
| **Temps/item** | 0.5s | 0.3s |
| **Audit** | Oui | Oui |

---

**Note** : Cette fonctionnalit√© respecte toutes les r√®gles de s√©curit√© et les standards Moodle d√©finis dans le projet. Consentement utilisateur obligatoire avant toute modification.

